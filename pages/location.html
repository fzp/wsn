<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script type="text/javascript" charset="utf-8" src="/static/d3.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/location/data.js"></script>
    <style>
        body {
            font-size: 1em;
            line-height: 1.4;
        }
        body {
            background:#fefdf5;
            height: 100%;
            width: 100%;
            font-family:'Trade Gothic Next W01',sans-serif;
            color:#333;
        }
        #chart {
            position:relative;
        }
        svg {
            font-family:'Trade Gothic Next W01',sans-serif;
            /*background:rgba(255,255,255,0.3);
            border:1px solid rgba(255,255,255,0.6);*/
        }
        rect {
            fill: transparent;
            shape-rendering: crispEdges;
        }
        .hex {
        }
        .active polygon{
            opacity: 1.0;
        }
        .inactive polygon {
            opacity: 0.1;
        }
        .axis {
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: rgba(0,0,0,0.1);
            shape-rendering: crispEdges;
        }
        .axis text {
            font-family: sans-serif;
            font-size: 11px;
            fill: #666;
        }
        .label {
            font-size:14px;
            fill:rgba(0,0,0,0.5);
            shape-rendering:auto;
        }
        .invisible {
            visibility: hidden;
        }
    </style>
</head>
<body>
    <svg id="map" ></svg>
    <svg id="timeLine" ></svg>
</body>
<script>
    var data = [];
    var mapSvg;
    getData("/Data/NodeInfo", function(AjaxData){
        var jsonObj = JSON.parse(AjaxData);
        var data = [];
        for(var nodeId in jsonObj) {
            var nodeInfo = jsonObj[nodeId];
            var d = {"latitude":nodeInfo[2],
                "longitude":nodeInfo[3]
            };
            data.push(d);
        }
        console.log(data);
        var margin = {top: 30, right: 10, bottom: 20, left: 60},
                width = window.innerWidth - margin.left - margin.right,
                height = window.innerHeight - margin.top - margin.bottom - 100;

        var xMax = d3.max(data, function(d) { return +d.latitude; }),
                xMin = d3.min(data, function(d) { return +d.latitude; }),
                yMax = d3.max(data, function(d) { return +d.longitude; }),
                yMin = d3.min(data, function(d) { return +d.longitude; });

        //Define scales
        var x = d3.scale.linear()
                .domain([xMin, xMax])
                .range([0, width]);

        var y = d3.scale.linear()
                .domain([yMin, yMax])
                .range([height, 0]);

        var colourScale = function(val){
            var colours = ['#9d3d38','#c5653a','#f9b743','#9bd6d7'];
            if (val > 30) {
                return colours[0];
            } else if (val > 10) {
                return colours[1];
            } else if (val > 0) {
                return colours[2];
            } else {
                return colours[3];
            }
        };


        //Define X axis
        var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom")
                .tickSize(-height)
                .tickFormat(d3.format("s"));

        //Define Y axis
        var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left")
                .ticks(5)
                .tickSize(-width)
                .tickFormat(d3.format("s"));

        var svg = d3.select("#map")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .call(d3.behavior.zoom().x(x).y(y).scaleExtent([1, 8]).on("zoom", zoom))
                .call(d3.behavior.drag().on("drag", function(){
//                    console.log(xAxis.scale().domain());
                    svg.selectAll("polygon")
                            .attr("opacity", function(d){
                                if( d.latitude < xAxis.scale().domain()[0] || d.longitude < yAxis.scale().domain()[0] ||
                                        d.latitude > xAxis.scale().domain()[1] || d.longitude > yAxis.scale().domain()[1]) {
                                    return "0.1";
                                } else {
                                    return "1.0"
                                }
                            });
                }));
        mapSvg = svg;

        svg.append("rect")
                .attr("width", width)
                .attr("height", height);

        svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

        svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);

        var poly = svg.selectAll("polygon")
                .data(data)
                .enter()
                .append("polygon")
                .attr("class","hex")
                .attr("transform", function(d, i) {
                    return "translate("+x(d.latitude)+","+y(d.longitude)+")";
                })
                .attr('points','4.569,2.637 0,5.276 -4.569,2.637 -4.569,-2.637 0,-5.276 4.569,-2.637')
                .attr("fill",function(d) {
                    return colourScale(30);
                });

        function zoom() {
            svg.selectAll("polygon")
                    .attr("transform", function(d, i) {
                        return "translate("+x(d.latitude)+","+y(d.longitude)+")";
                    })
                    .attr('points','4.569,2.637 0,5.276 -4.569,2.637 -4.569,-2.637 0,-5.276 4.569,-2.637');
            svg.select(".x.axis").call(xAxis);
            svg.select(".y.axis").call(yAxis);
        }
    });
    getData("/Rep/meta", function(AjaxData){
        var repMeta = JSON.parse(AjaxData);
        var data = [];
        var margin = {top: 30, right: 10, bottom: 20, left: 60},
                width = window.innerWidth - margin.left - margin.right,
                height = 100;
        console.log(repMeta);
        for(var day in repMeta){
            for(var hour in repMeta[day]){
                for(var minute in repMeta[day][hour]){
                    var d = {};
                    d.time = new Date(2011, 8, day, hour, minute);
                    d.value = repMeta[day][hour][minute];
                    data.push(d);
                }
            }
        }
        var x = d3.time.scale().range([0, width]),   //建立数据容器  把数值转为时间标度再转为宽度
                y = d3.scale.linear().range([height, 0]);//直线标度 Learning D3.js(1)学习制作一个柱形图/直方图

        var xAxis = d3.svg.axis().scale(x).orient("bottom"),//制作上图的X轴
                yAxis = d3.svg.axis().scale(y).orient("left");//制作上图的Y轴


        var area = d3.svg.area()//生成上图area 注意这个area是一个path，要利用attr(d)加载进去
                .x(function(d) { return x(d.time); })
                .y0(height) //https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-area
                .y1(function(d) { return y(d.value); });

        var svg = d3.select("#timeLine")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

        var focus = svg.append("g")//制作上图容器
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        x.domain(d3.extent(data.map(function(d) { return d.time; })));//利用domain方法给数据容器匹配上数据
        y.domain([0, d3.max(data.map(function(d) { return d.value; }))]);

        focus.append("path")
                .datum(data)
                .attr("d", area);
        //添加上面图的XY坐标轴
        focus.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis)
                .call(d3.behavior.zoom().on("zoom", zoom));

        focus.append("g")
                .attr("class", "y axis")
                .call(yAxis);

        focus.append("svg:rect")
                .attr("class", "pane")
                .attr("width", width)
                .attr("height", height);

        function zoom() {
            console.log(d3.event.transform);
            svg.select("#timeLine.x.axis").call(xAxis);
            svg.select("#timeLine.y.axis").call(yAxis);
        }
    });
</script>
</html>