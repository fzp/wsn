
<!DOCTYPE html>
<meta charset="utf-8">
<style>

    path {
        stroke: #fff;
    }

    path:first-child {
        fill: yellow !important;
    }

    circle {
        fill: #000;
        pointer-events: none;
    }

    .q0-9 { fill: #FE00FE; }
    .q1-9 { fill: #FE0000; }
    .q2-9 { fill: #FF6561; }
    .q3-9 { fill: #FE9962; }
    .q4-9 { fill: #FEFF94; }
    .q5-9 { fill: #CDFECE; }
    .q6-9 { fill: #9BFEFE; }
    .q7-9 { fill: #0195FE; }
    .q8-9 { fill: #FFFFFF; }

</style>
<body>
<script type="text/javascript" charset="utf-8" src="/static/d3.js"></script>
<script type="text/javascript" charset="utf-8" src="/static/location/data.js"></script>
<script>
    getData("/Data/NodeInfo", function(AjaxData) {
        getData("/Rep/duration/?s=2011-08-03 00-00-01&e=2011-08-03 00-10-01", function (response) {
            console.log("/Data/NodeInfo");
            var jsonObj = JSON.parse(AjaxData);
            var c1PackageList = JSON.parse(response);
            console.log(c1PackageList);
            var data = [];
            var vertices = [];
            var width = 960,
                    height = 500;
            for(var nodeId in jsonObj) {
                var nodeInfo = jsonObj[nodeId];
                var d = {
                    "nodeId":nodeInfo[0],
                    "latitude":nodeInfo[2],
                    "longitude":nodeInfo[3]
                };
                data.push(d);
            }
            var xMax = d3.max(data, function(d) { return +d.latitude; }),
                    xMin = d3.min(data, function(d) { return +d.latitude; }),
                    yMax = d3.max(data, function(d) { return +d.longitude; }),
                    yMin = d3.min(data, function(d) { return +d.longitude; });
            console.log([xMax, xMin, yMax, yMin]);
            var xGap = xMax-xMin, yGap=yMax-yMin;
            for(var i in data) {
                var d = data[i];
                vertices.push({
                    "p":
                            [
                                        (d['latitude'] - xMin) / xGap * width,
                                        (yMax - d['longitude']) / yGap * height
                            ],
                    "id": d.nodeId
                });
            }

            var voronoi = d3.geom.voronoi()
                    .x(function(d) { return (d.p[0]); })
                    .y(function(d) { return (d.p[1]); })
                    .clipExtent([[0, 0], [width, height]]);

            var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .on("mousemove", function() { vertices[0] = d3.mouse(this); redraw(); });

            var path = svg.append("g").selectAll("path");

            svg.selectAll("circle")
                    .data(vertices.slice(1))
                    .enter().append("circle")
                    .attr("transform", function(d) { return "translate(" + d.p + ")"; })
                    .attr("r", 1.5);

            redraw();

            function redraw() {
                path = path
                        .data(voronoi(vertices), polygon);

                path.exit().remove();

                path.enter().append("path")
                        .attr("class", function(d, i) {
                            var Obj = c1PackageList[parseInt(d.point.id)];
                            if(Obj) {
                                var temp = c1PackageList[parseInt(d.point.id)].humidity;
                                if(temp > 200) return "q8-9";
                                if (temp > 100) return "q0-9";
                                else if (temp > 98) return "q1-9";
                                else if (temp > 96) return "q1-9";
                                else if (temp > 94) return "q2-9";
                                else if (temp > 92) return "q3-9";
                                else if (temp > 90) return "q4-9";
                                else return "q8-9";
                            }else{
                                return "q8-9";
                            }})
                        .attr("d", polygon);

                path.order();

            }

            function polygon(d) {
                return "M" + d.join("L") + "Z";
            }
        });
    });
</script>
</body>